name: CD (Deploy to Yandex VPS)

on:
  workflow_call:
    inputs:
      checkout_ref:
        required: true
        type: string
      deploy_branch:
        required: true
        type: string
    secrets:
      DEPLOY_HOST:
        required: true
      DEPLOY_USER:
        required: true
      DEPLOY_SSH_KEY:
        required: true
      S3_ENV:
        required: false
      YANDEX_CLOUD_ENV:
        required: false

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout_ref }}

      - name: Detect project base dir
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import pathlib, os
          root = pathlib.Path(".").resolve()

          base = None
          for p in root.rglob("api-gateway/docker-compose.yaml"):
            if ".git" in p.parts:
              continue
            base = p.parent.parent
            break

          if base is None:
            raise SystemExit("Cannot find api-gateway/docker-compose.yaml in repo")

          rel = str(base.relative_to(root))
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"base={rel}\n")
          print("Detected base:", rel)
          PY

      - name: Prepare SSH
        shell: bash
        env:
          HOST: ${{ secrets.DEPLOY_HOST }}
          KEY:  ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf "%s" "$KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts

      - name: Rsync code to server
        shell: bash
        env:
          HOST: ${{ secrets.DEPLOY_HOST }}
          USER: ${{ secrets.DEPLOY_USER }}
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y rsync

          if [ "${{ inputs.deploy_branch }}" = "main" ]; then
            REMOTE_DIR="/opt/anti-plagiarism/prod"
          else
            REMOTE_DIR="/opt/anti-plagiarism/dev"
          fi
          echo "REMOTE_DIR=$REMOTE_DIR" >> "$GITHUB_ENV"

          ssh -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=no \
            "${USER}@${HOST}" "sudo mkdir -p '${REMOTE_DIR}/repo' && sudo chown -R '${USER}:${USER}' '/opt/anti-plagiarism'"

          rsync -az --delete \
            -e "ssh -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=no" \
            --exclude ".git" \
            --exclude ".DS_Store" \
            --exclude "__MACOSX" \
            "./" "${USER}@${HOST}:${REMOTE_DIR}/repo"

      - name: Deploy (validate compose + docker compose up)
        shell: bash
        env:
          HOST: ${{ secrets.DEPLOY_HOST }}
          USER: ${{ secrets.DEPLOY_USER }}
          BASE: ${{ steps.detect.outputs.base }}
          S3_ENV: ${{ secrets.S3_ENV }}
          YANDEX_CLOUD_ENV: ${{ secrets.YANDEX_CLOUD_ENV }}
        run: |
          set -euo pipefail

          S3_B64="$(printf "%s" "${S3_ENV:-}" | base64 -w0)"
          YC_B64="$(printf "%s" "${YANDEX_CLOUD_ENV:-}" | base64 -w0)"

          ssh -i ~/.ssh/id_ed25519 -o IdentitiesOnly=yes -o StrictHostKeyChecking=no \
            "${USER}@${HOST}" "REMOTE_DIR='${REMOTE_DIR}' BASE='${BASE}' S3_B64='${S3_B64}' YC_B64='${YC_B64}' bash -s" <<'SCRIPT'
          set -euo pipefail

          cd "$REMOTE_DIR/repo/$BASE"

          if [ -n "${S3_B64:-}" ]; then
            mkdir -p file-storing/internal/env-files
            printf "%s" "$S3_B64" | base64 -d > file-storing/internal/env-files/s3.env
          fi

          if [ -n "${YC_B64:-}" ]; then
            mkdir -p embedding-service/internal/env-files
            printf "%s" "$YC_B64" | base64 -d > embedding-service/internal/env-files/yandexCloud.env
          fi

          sudo -n docker version >/dev/null
          sudo -n docker compose version >/dev/null

          validate() {
            local f="$1"
            if [ -f "$f" ]; then
              echo "== Validating: $f =="
              sudo -n docker compose -f "$f" config >/dev/null
            fi
          }

          validate "./docker-compose.yaml"
          validate "./embedding-service/docker-compose.yaml"
          validate "./file-storing/docker-compose.yaml"
          validate "./file-analisys/docker-compose.yaml"
          validate "./api-gateway/docker-compose.yaml"

          if [ -f docker-compose.yaml ]; then
            sudo -n docker compose up -d --build
          fi

          sudo -n docker image prune -f >/dev/null 2>&1 || true
          SCRIPT
